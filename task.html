<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTW Task Detail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="board-container">
    <h1 class="board-title text-center">üìú Task Details</h1>
    <div id="taskDetail" class="poster-card mx-auto" style="max-width: 700px;">
      <!-- Populated by JS -->
    </div>
    <div class="text-center mt-4">
      <a href="index.html" class="btn btn-dark">‚¨Ö Back to Wanted Board</a>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDAVEsmPu_-cGxXgF4DSKukAD144P3-gXM",
      authDomain: "htwearntasklist.firebaseapp.com",
      projectId: "htwearntasklist",
      storageBucket: "htwearntasklist.firebasestorage.app",
      messagingSenderId: "60450712031",
      appId: "1:60450712031:web:4d1ad94f53639d3275bc6a",
      measurementId: "G-NBK6ZC4LJY"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const taskDetail = document.getElementById("taskDetail");
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get("id");

    if (taskId) {
      db.collection("tasks").doc(taskId).get().then((doc) => {
        if (doc.exists) {
          const task = doc.data();
          const imageUrl = task.imageUrl || '';
          taskDetail.innerHTML = `
            <div class="poster-banner">WANTED</div>
            <h2 class="card-title">${task.title}</h2>

            <div class="poster-image-box">
              ${imageUrl ? `<img src="${imageUrl}" alt="${task.title}">` : '<div class="no-image-text">NO IMAGE</div>'}
            </div>

            <p class="card-text"><strong>Description:</strong><br>${task.fullDescription || task.description}</p>

            <div class="bounty-section">
              <div class="bounty-label">Bounty (USD)</div>
              <div class="bounty-amount">$${task.bounty}</div>
            </div>

            <div class="status-band">${task.status || 'OPEN'}</div>

            <form id="submissionForm" class="mt-4 text-start">
              <div class="mb-3">
                <label class="form-label">Your Name</label>
                <input type="text" class="form-control" id="submitterName" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Contact Info (Email/Phone)</label>
                <input type="text" class="form-control" id="submitterContact" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Upload File</label>
                <input type="file" class="form-control" id="submissionFile" required>
              </div>
              <button type="submit" id="submitBtn" class="btn btn-success w-100">Submit Work</button>
            </form>
          `;

          const submissionForm = document.getElementById('submissionForm');
          
          submissionForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const name = document.getElementById("submitterName").value;
            const contact = document.getElementById("submitterContact").value;
            const file = document.getElementById("submissionFile").files[0];
            const submitBtn = document.getElementById('submitBtn');

            if (!file) {
              alert("Please upload a file before submitting.");
              return;
            }

            // Disable button
            submitBtn.disabled = true;

            const storageRef = storage.ref(`submissions/${taskId}/${Date.now()}_${file.name}`);
            const uploadTask = storageRef.put(file);

            // Listen for state changes, errors, and completion of the upload.
            uploadTask.on('state_changed',
              (snapshot) => {
                // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                submitBtn.textContent = `Uploading: ${progress.toFixed(0)}%`;
              },
              (error) => {
                console.error("Upload failed:", error);
                let errorMessage = "File upload failed. Please try again.";
                switch (error.code) {
                  case 'storage/unauthorized':
                    errorMessage = "Permission Denied. Please check the site's Firebase Storage rules.";
                    break;
                  case 'storage/canceled':
                    errorMessage = "Upload Canceled.";
                    break;
                  case 'storage/unknown':
                    errorMessage = "An unknown error occurred. Please check the console for more details.";
                    break;
                }
                alert(errorMessage);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Work';
              },
              () => {
                // Upload completed successfully, now we can get the download URL
                uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
                  try {
                    await db.collection("tasks").doc(taskId).collection("submissions").add({
                      name,
                      contact,
                      fileUrl: downloadURL,
                      fileName: file.name,
                      submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    await db.collection('tasks').doc(taskId).update({ status: 'IN REVIEW' });

                    alert("Submission uploaded successfully!");
                    submissionForm.reset();
                    document.querySelector('.status-band').textContent = 'IN REVIEW';
                    submitBtn.textContent = 'Submitted!';
                    submitBtn.disabled = true; // Keep disabled after successful submission

                  } catch (dbError) {
                      console.error("Error writing to database: ", dbError);
                      alert("File uploaded, but failed to save submission data. Please contact an admin.");
                      submitBtn.disabled = false;
                      submitBtn.textContent = 'Submit Work';
                  }
                });
              }
            );
          });
        } else {
          taskDetail.innerHTML = "<p class='text-center text-danger'>‚ùå Task not found</p>";
        }
      });
    } else {
      taskDetail.innerHTML = "<p class='text-center text-warning'>‚ö† No task selected</p>";
    }
  </script>
</body>
</html>